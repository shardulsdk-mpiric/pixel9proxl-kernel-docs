# KernelSU Integration Guide for Pixel 9 Pro XL

## Overview

This guide provides step-by-step instructions for integrating KernelSU into the Pixel 9 Pro XL (caimito) kernel build. KernelSU is a kernel-based root solution that requires integration at the kernel source level and proper build system configuration to ensure it gets built and included in the boot images.

## Navigation

- [Guides Index](README.md)
- [Main Documentation Index](../README.md)
- [KernelSU Analysis](../analysis/13-kernelsu-root-solution.md)

---

## Table of Contents

1. [Prerequisites](#1-prerequisites)
2. [Integration Planning](#2-integration-planning)
3. [Understanding Build System Integration](#3-understanding-build-system-integration)
4. [Step 1: Add KernelSU Source Code](#4-step-1-add-kernelsu-source-code)
5. [Step 2: Integrate KernelSU into Kconfig](#5-step-2-integrate-kernelsu-into-kconfig)
6. [Step 3: Configure Kernel Build](#6-step-3-configure-kernel-build)
7. [Step 4: Verify Build Integration](#7-step-4-verify-build-integration)
8. [Step 5: Build and Test](#8-step-5-build-and-test)
9. [Troubleshooting](#9-troubleshooting)

---

## 1. Prerequisites

Before starting, ensure you have:

- ✅ Clean kernel source tree at `/mnt/work_4gb/sources/android/pixel_9_pro_xl/002_kernel/`
- ✅ Understanding of the build system (see [Build Command Flow](../analysis/03-build-command-flow.md))
- ✅ Understanding of kernel configuration (see [Build Configuration System](../analysis/02-build-configuration.md))
- ✅ Understanding of module system (see [Module System](../analysis/04-module-system.md))
- ✅ Basic knowledge of Git and terminal commands

---

## 2. Integration Planning

### 2.1 What Needs to Happen

For KernelSU to work on your device, we need to:

1. **Add KernelSU source code** to the kernel tree
2. **Integrate KernelSU into Kconfig** system so it can be configured
3. **Enable KernelSU in defconfig** so it gets built
4. **Ensure KernelSU gets built** as part of the kernel build
5. **Verify KernelSU is included** in boot images
6. **Build and flash** the kernel to test

### 2.2 Build System Considerations

KernelSU can be built in two ways:
- **As built-in** (`CONFIG_KSU=y`): Compiled directly into the kernel Image
- **As a module** (`CONFIG_KSU=m`): Built as a separate `.ko` file

For Pixel 9 Pro XL, we need to understand:
- How the Bazel/Kleaf build system handles kernel configuration
- How modules are built and included in vendor_dlkm/system_dlkm
- How the kernel Image is created and included in boot.img

### 2.3 Integration Points

Key integration points:
- **Kconfig**: `aosp/drivers/Kconfig` - Add KernelSU menu entry
- **Makefile**: `aosp/drivers/Makefile` - Add KernelSU build target
- **Defconfig**: `private/devices/google/caimito/caimito_defconfig` - Enable KernelSU
- **BUILD.bazel**: May need updates if KernelSU is built as module

---

## 3. Understanding Build System Integration

### 3.1 How Kernel Configuration Works

From [Build Configuration System](../analysis/02-build-configuration.md):

1. **Defconfig fragments** are defined in `BUILD.bazel`
2. **Kernel config** is generated by merging defconfig fragments
3. **Kconfig extensions** can add custom configuration options
4. **Build system** applies configuration during build

### 3.2 How Modules Are Built

From [Module System](../analysis/04-module-system.md):

1. **Module sources** are in `private/google-modules/` or `aosp/drivers/`
2. **Module build** is handled by `kernel_build` rule
3. **Module outputs** are specified in `module_outs` attribute
4. **Modules** are installed to `vendor_dlkm` or `system_dlkm` partitions

### 3.3 KernelSU Build Integration

KernelSU needs to:
- Be added to `aosp/drivers/kernelsu/` directory
- Have its Kconfig integrated into `aosp/drivers/Kconfig`
- Have its Makefile integrated into `aosp/drivers/Makefile`
- Be enabled via `CONFIG_KSU=y` or `CONFIG_KSU=m` in defconfig
- If built-in (`CONFIG_KSU=y`): Automatically included in kernel Image
- If module (`CONFIG_KSU=m`): Must be included in `module_outs` in BUILD.bazel

### 3.4 Built-in vs Module Choice

**For Pixel 9 Pro XL (GKI kernel):**
- **Built-in (`CONFIG_KSU=y`)**: Recommended for simplicity
  - Compiled directly into kernel Image
  - No need for module loading
  - Automatically included in boot.img
  - Simpler integration with Bazel/Kleaf build system

- **Module (`CONFIG_KSU=m`)**: Possible but more complex
  - Built as separate `kernelsu.ko` file
  - Must be loaded during boot
  - Needs to be included in vendor_dlkm or system_dlkm
  - Requires module loading infrastructure

---

## 4. Step 1: Add KernelSU Source Code

### 4.1 Download KernelSU

KernelSU can be integrated using the official setup script or manually. We'll use the setup script for simplicity:

```bash
cd /mnt/work_4gb/sources/android/pixel_9_pro_xl/002_kernel/aosp
curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
```

This script will:
- Clone KernelSU repository into `aosp/KernelSU/`
- Copy kernel driver code to `aosp/drivers/kernelsu/`
- Apply necessary kernel patches
- Set up build configuration

### 4.2 Verify Integration

After running the setup script, verify:

```bash
# Check KernelSU source code
ls -la aosp/drivers/kernelsu/
ls -la aosp/KernelSU/

# Check if patches were applied
git status
```

Expected outputs:
- `aosp/drivers/kernelsu/` should contain KernelSU driver source files
- `aosp/KernelSU/` should contain the KernelSU repository
- Git should show modified/new files

---

## 5. Step 2: Integrate KernelSU into Kconfig

### 5.1 Check Kconfig Integration

The setup script should automatically add KernelSU to `aosp/drivers/Kconfig`. Verify:

```bash
grep -i kernelsu aosp/drivers/Kconfig
```

Expected output should show:
```
source "drivers/kernelsu/Kconfig"
```

### 5.2 Manual Integration (if needed)

If the setup script didn't add it automatically:

1. Open `aosp/drivers/Kconfig`
2. Find a suitable location (e.g., after other security-related drivers)
3. Add:
   ```
   source "drivers/kernelsu/Kconfig"
   ```

### 5.3 Verify KernelSU Kconfig

Check that KernelSU's Kconfig file exists and is valid:

```bash
cat aosp/drivers/kernelsu/Kconfig
```

Expected contents should show:
- `menu "KernelSU"`
- `config KSU` option
- `depends on KPROBES`
- `config KSU_DEBUG` option

---

## 6. Step 3: Configure Kernel Build

### 6.1 Check KPROBES Support

KernelSU requires `CONFIG_KPROBES`. Check if it's enabled:

```bash
grep -i kprobes private/devices/google/caimito/caimito_defconfig
```

If not present, we may need to enable it (but GKI kernels typically have it enabled).

### 6.2 Add KernelSU to Defconfig

Add KernelSU configuration to `private/devices/google/caimito/caimito_defconfig`:

```bash
# Add to defconfig file
echo "CONFIG_KSU=y" >> private/devices/google/caimito/caimito_defconfig
```

**Note**: 
- Use `CONFIG_KSU=y` for built-in (recommended for GKI)
- Use `CONFIG_KSU=m` for module (if you want it as a separate module)

### 6.3 Optional: Enable Debug Mode

For development/testing, you can enable debug mode:

```bash
echo "CONFIG_KSU_DEBUG=y" >> private/devices/google/caimito/caimito_defconfig
```

### 6.4 Verify Defconfig Changes

```bash
grep -i ksu private/devices/google/caimito/caimito_defconfig
```

---

## 7. Step 4: Verify Build Integration

### 7.1 Check Build System Integration

The setup script should integrate KernelSU into the build system. Verify Makefile integration:

```bash
grep -i kernelsu aosp/drivers/Makefile
```

Expected output:
```
obj-$(CONFIG_KSU) += kernelsu/
```

### 7.2 Check Bazel Integration

**For built-in KernelSU (`CONFIG_KSU=y`)**:
- No Bazel integration needed
- KernelSU is compiled directly into kernel Image
- Automatically included in boot.img during image creation

**For module KernelSU (`CONFIG_KSU=m`)**:
- Must be included in `module_outs` in BUILD.bazel
- Check if `kernelsu.ko` needs to be explicitly listed:

```bash
grep -i "module_outs\|kernelsu" private/devices/google/caimito/BUILD.bazel
```

If KernelSU is built as a module, you may need to add it to the `module_outs` list. However, the kernel build system should automatically include all modules built with `CONFIG_KSU=m` if the build system is properly configured.

**Recommendation**: Use built-in (`CONFIG_KSU=y`) to avoid module complexity.

### 7.3 Verify Kconfig Integration in Build

Test that KernelSU configuration appears in kernel config:

```bash
# This will be tested during actual build, but we can verify structure
```

---

## 8. Step 5: Build and Test

### 8.1 Clean Build (Optional)

For a clean build:

```bash
cd /mnt/work_4gb/sources/android/pixel_9_pro_xl/002_kernel
# Clean Bazel cache if needed
tools/bazel clean
```

### 8.2 Build Kernel

Build the kernel with KernelSU:

```bash
./build_caimito.sh
```

### 8.3 Verify Build Outputs

Check that KernelSU was built:

```bash
# If built-in, check kernel Image
ls -lh out/caimito/dist/Image*

# If module, check for kernelsu.ko
find out/caimito/dist -name "kernelsu.ko"
```

### 8.4 Check Build Logs

Verify KernelSU compilation in build logs:

```bash
# Look for KernelSU-related messages
grep -i kernelsu out/caimito/dist/*.log 2>/dev/null || echo "Check build output for KernelSU messages"
```

### 8.5 Verify Configuration

Verify KernelSU is enabled in final .config:

```bash
# The .config file should be in build outputs
grep -i "^CONFIG_KSU" out/caimito/dist/.config
```

Expected output:
```
CONFIG_KSU=y
```

---

## 9. Troubleshooting

### 9.1 KernelSU Not Appearing in Config

**Problem**: `CONFIG_KSU` not available in kernel config

**Solution**:
1. Verify `source "drivers/kernelsu/Kconfig"` is in `aosp/drivers/Kconfig`
2. Check that `aosp/drivers/kernelsu/Kconfig` exists
3. Ensure setup script completed successfully

### 9.2 KPROBES Not Enabled

**Problem**: KernelSU fails because `CONFIG_KPROBES` is not enabled

**Solution**:
1. Check if KPROBES is in defconfig: `grep KPROBES private/devices/google/caimito/caimito_defconfig`
2. If not, add `CONFIG_KPROBES=y` (but verify it's compatible with GKI first)
3. For GKI kernels, KPROBES is typically already enabled

### 9.3 Build Errors

**Problem**: Build fails with KernelSU-related errors

**Solution**:
1. Check build logs for specific error messages
2. Verify kernel version compatibility with KernelSU
3. Check if all KernelSU patches were applied correctly
4. Review KernelSU GitHub issues for similar problems

### 9.4 KernelSU Not in Boot Image

**Problem**: KernelSU is built but not in boot image

**Solution**:
1. If built-in (`CONFIG_KSU=y`), it should be in kernel Image automatically
2. If module (`CONFIG_KSU=m`), verify it's in module outputs and included in vendor_dlkm/system_dlkm
3. Check BUILD.bazel for module inclusion

---

## Next Steps

After successful integration:

1. **Flash kernel** to device (see [Flashing Guide](../analysis/09-flashing-deployment.md))
2. **Install KernelSU Manager** app (APK from GitHub releases)
3. **Verify root access** works correctly
4. **Test stability** and compatibility

---

## References

- [KernelSU Official Documentation](https://kernelsu.org)
- [KernelSU GitHub Repository](https://github.com/tiann/KernelSU)
- [KernelSU Analysis](../analysis/13-kernelsu-root-solution.md)
- [Build Configuration System](../analysis/02-build-configuration.md)
- [Module System](../analysis/04-module-system.md)
- [Flashing and Deployment](../analysis/09-flashing-deployment.md)

---

## Summary

This guide covers the complete KernelSU integration process:

1. ✅ Add KernelSU source code via setup script
2. ✅ Verify Kconfig integration
3. ✅ Enable KernelSU in defconfig
4. ✅ Verify build system integration
5. ✅ Build and test

The key is ensuring KernelSU configuration (`CONFIG_KSU`) is properly integrated into the kernel build system and that it gets compiled and included in the boot images.

